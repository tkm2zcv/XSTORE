# チケット #009: 買取申込ページ

## 概要
ユーザーがTwitterアカウントの買取申込を行うフォームページを実装します。

## 目的
- 買取申込フォームの作成
- バリデーション実装
- 画像アップロード機能
- Supabaseへのデータ保存
- 送信完了メッセージ表示

## タスク

### ページファイル作成
- [ ] `/app/(public)/purchase/page.tsx` 作成

### 買取申込フォームコンポーネント
- [ ] `/components/forms/PurchaseForm.tsx` 作成
  - Twitter ID入力
  - 希望価格入力
  - 連絡先入力（メール、Twitter、Instagram）
  - 画像ツイートアップロード

### バリデーション
- [ ] Zodスキーマ作成（`/lib/validations.ts`）
  - Twitter ID形式チェック
  - 価格範囲チェック
  - メールアドレス形式チェック
  - 必須項目チェック

### 画像アップロード
- [ ] Supabase Storageセットアップ
  - バケット作成（`tweet-images`）
  - アップロード機能実装
  - 画像サイズ・形式制限

### API Route作成
- [ ] `/app/api/purchase-requests/route.ts` 作成
  - POST: 申込データ保存
  - バリデーション
  - エラーハンドリング

### 送信完了ページ
- [ ] `/app/(public)/purchase/success/page.tsx` 作成
  - 送信完了メッセージ
  - トップページへのリンク

### Shadcn/ui コンポーネント追加
- [ ] Form コンポーネント追加
- [ ] Textarea コンポーネント追加
- [ ] Toast コンポーネント追加

### react-hook-form インストール
- [ ] react-hook-form インストール
- [ ] @hookform/resolvers インストール

## 技術的な詳細

### ライブラリインストール
```bash
npm install react-hook-form @hookform/resolvers
```

### lib/validations.ts
```typescript
import { z } from 'zod';

export const purchaseRequestSchema = z.object({
  twitter_username: z
    .string()
    .min(1, 'Twitter IDは必須です')
    .regex(
      /^@?[A-Za-z0-9_]+$/,
      '正しいTwitter IDを入力してください（例: @username）'
    ),
  desired_price: z
    .number({
      required_error: '希望価格は必須です',
      invalid_type_error: '数値を入力してください',
    })
    .min(1, '1円以上を入力してください')
    .max(10000000, '価格が高すぎます'),
  contact_email: z
    .string()
    .email('正しいメールアドレスを入力してください')
    .optional()
    .or(z.literal('')),
  contact_twitter: z.string().optional(),
  contact_instagram: z.string().optional(),
  tweet_image: z
    .instanceof(File)
    .refine((file) => file.size <= 5000000, '画像サイズは5MB以下にしてください')
    .refine(
      (file) => ['image/jpeg', 'image/png', 'image/webp'].includes(file.type),
      'JPEG、PNG、WebP形式の画像のみアップロード可能です'
    )
    .optional(),
}).refine(
  (data) =>
    data.contact_email || data.contact_twitter || data.contact_instagram,
  {
    message: '少なくとも1つの連絡先を入力してください',
    path: ['contact_email'],
  }
);

export type PurchaseRequestFormData = z.infer<typeof purchaseRequestSchema>;
```

### app/(public)/purchase/page.tsx
```typescript
import { Metadata } from 'next';
import { PurchaseForm } from '@/components/forms/PurchaseForm';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';

export const metadata: Metadata = {
  title: 'アカウント買取申込 | Twitter Account Market',
  description: 'Twitterアカウントの買取申込フォーム',
};

export default function PurchasePage() {
  return (
    <div className="container max-w-2xl py-8">
      <Card>
        <CardHeader>
          <CardTitle className="text-3xl">アカウント買取申込</CardTitle>
          <CardDescription>
            以下のフォームに必要事項を入力してください。
            担当者が確認後、ご連絡させていただきます。
          </CardDescription>
        </CardHeader>
        <CardContent>
          <PurchaseForm />
        </CardContent>
      </Card>

      <div className="mt-8 rounded-lg bg-muted/40 p-6">
        <h3 className="mb-4 font-semibold">ご注意事項</h3>
        <ul className="space-y-2 text-sm text-muted-foreground">
          <li>• 画像ツイートは、ハッシュタグやメンションを含まないものをアップロードしてください</li>
          <li>• 買取価格は審査後に決定します。希望価格と異なる場合があります</li>
          <li>• 申込後、3営業日以内にご連絡いたします</li>
          <li>• アカウント情報は厳重に管理いたします</li>
        </ul>
      </div>
    </div>
  );
}
```

### components/forms/PurchaseForm.tsx
```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { purchaseRequestSchema, PurchaseRequestFormData } from '@/lib/validations';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { useToast } from '@/components/ui/use-toast';
import { Loader2 } from 'lucide-react';

export function PurchaseForm() {
  const router = useRouter();
  const { toast } = useToast();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [imageFile, setImageFile] = useState<File | null>(null);

  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<PurchaseRequestFormData>({
    resolver: zodResolver(purchaseRequestSchema),
  });

  const onSubmit = async (data: PurchaseRequestFormData) => {
    setIsSubmitting(true);

    try {
      const formData = new FormData();
      formData.append('twitter_username', data.twitter_username);
      formData.append('desired_price', data.desired_price.toString());
      if (data.contact_email) formData.append('contact_email', data.contact_email);
      if (data.contact_twitter) formData.append('contact_twitter', data.contact_twitter);
      if (data.contact_instagram) formData.append('contact_instagram', data.contact_instagram);
      if (imageFile) formData.append('tweet_image', imageFile);

      const response = await fetch('/api/purchase-requests', {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        throw new Error('送信に失敗しました');
      }

      toast({
        title: '送信完了',
        description: '買取申込を受け付けました。担当者よりご連絡いたします。',
      });

      router.push('/purchase/success');
    } catch (error) {
      toast({
        title: 'エラー',
        description: '送信に失敗しました。もう一度お試しください。',
        variant: 'destructive',
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
      {/* Twitter ID */}
      <div className="space-y-2">
        <Label htmlFor="twitter_username">Twitter ID *</Label>
        <Input
          id="twitter_username"
          placeholder="@username"
          {...register('twitter_username')}
        />
        {errors.twitter_username && (
          <p className="text-sm text-destructive">{errors.twitter_username.message}</p>
        )}
      </div>

      {/* 希望価格 */}
      <div className="space-y-2">
        <Label htmlFor="desired_price">希望価格（円） *</Label>
        <Input
          id="desired_price"
          type="number"
          placeholder="100000"
          {...register('desired_price', { valueAsNumber: true })}
        />
        {errors.desired_price && (
          <p className="text-sm text-destructive">{errors.desired_price.message}</p>
        )}
      </div>

      {/* 連絡先 */}
      <div className="space-y-4">
        <Label>連絡先（いずれか1つ以上必須） *</Label>

        <div className="space-y-2">
          <Label htmlFor="contact_email" className="text-sm font-normal">
            メールアドレス
          </Label>
          <Input
            id="contact_email"
            type="email"
            placeholder="your@email.com"
            {...register('contact_email')}
          />
          {errors.contact_email && (
            <p className="text-sm text-destructive">{errors.contact_email.message}</p>
          )}
        </div>

        <div className="space-y-2">
          <Label htmlFor="contact_twitter" className="text-sm font-normal">
            Twitter ID
          </Label>
          <Input
            id="contact_twitter"
            placeholder="@your_twitter"
            {...register('contact_twitter')}
          />
        </div>

        <div className="space-y-2">
          <Label htmlFor="contact_instagram" className="text-sm font-normal">
            Instagram ID
          </Label>
          <Input
            id="contact_instagram"
            placeholder="@your_instagram"
            {...register('contact_instagram')}
          />
        </div>
      </div>

      {/* 画像ツイート */}
      <div className="space-y-2">
        <Label htmlFor="tweet_image">
          画像ツイート（ハッシュタグやメンションなし）
        </Label>
        <Input
          id="tweet_image"
          type="file"
          accept="image/jpeg,image/png,image/webp"
          onChange={(e) => {
            const file = e.target.files?.[0];
            if (file) setImageFile(file);
          }}
        />
        <p className="text-sm text-muted-foreground">
          JPEG、PNG、WebP形式、5MB以下
        </p>
        {errors.tweet_image && (
          <p className="text-sm text-destructive">{errors.tweet_image.message}</p>
        )}
      </div>

      <Button type="submit" className="w-full" size="lg" disabled={isSubmitting}>
        {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
        申込を送信
      </Button>
    </form>
  );
}
```

### app/api/purchase-requests/route.ts
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase';
import { purchaseRequestSchema } from '@/lib/validations';

export async function POST(request: NextRequest) {
  try {
    const formData = await request.formData();

    const data = {
      twitter_username: formData.get('twitter_username') as string,
      desired_price: parseInt(formData.get('desired_price') as string),
      contact_email: formData.get('contact_email') as string || undefined,
      contact_twitter: formData.get('contact_twitter') as string || undefined,
      contact_instagram: formData.get('contact_instagram') as string || undefined,
    };

    // バリデーション（画像は除く）
    const validatedData = purchaseRequestSchema.omit({ tweet_image: true }).parse(data);

    const supabase = createClient();

    // 画像アップロード処理
    let imageUrl: string | null = null;
    const imageFile = formData.get('tweet_image') as File;

    if (imageFile && imageFile.size > 0) {
      const fileExt = imageFile.name.split('.').pop();
      const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;

      const { data: uploadData, error: uploadError } = await supabase
        .storage
        .from('tweet-images')
        .upload(fileName, imageFile);

      if (uploadError) {
        console.error('Image upload error:', uploadError);
      } else {
        const { data: urlData } = supabase
          .storage
          .from('tweet-images')
          .getPublicUrl(fileName);
        imageUrl = urlData.publicUrl;
      }
    }

    // データベースに保存
    const { data: insertData, error: insertError } = await supabase
      .from('purchase_requests')
      .insert({
        ...validatedData,
        tweet_image_url: imageUrl,
      })
      .select()
      .single();

    if (insertError) {
      console.error('Database insert error:', insertError);
      return NextResponse.json(
        { error: 'データの保存に失敗しました' },
        { status: 500 }
      );
    }

    return NextResponse.json({ success: true, data: insertData });
  } catch (error) {
    console.error('Purchase request error:', error);
    return NextResponse.json(
      { error: '申込の処理に失敗しました' },
      { status: 500 }
    );
  }
}
```

### app/(public)/purchase/success/page.tsx
```typescript
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { CheckCircle2 } from 'lucide-react';

export default function PurchaseSuccessPage() {
  return (
    <div className="container flex min-h-[60vh] items-center justify-center">
      <Card className="max-w-md">
        <CardHeader className="text-center">
          <div className="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-primary/10">
            <CheckCircle2 className="h-8 w-8 text-primary" />
          </div>
          <CardTitle className="text-2xl">送信完了</CardTitle>
          <CardDescription>
            買取申込を受け付けました
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <p className="text-center text-sm text-muted-foreground">
            担当者が内容を確認後、3営業日以内にご連絡させていただきます。
            今しばらくお待ちください。
          </p>
          <Button className="w-full" asChild>
            <Link href="/">トップページへ</Link>
          </Button>
        </CardContent>
      </Card>
    </div>
  );
}
```

### Shadcn/ui コンポーネント追加
```bash
npx shadcn-ui@latest add form
npx shadcn-ui@latest add textarea
npx shadcn-ui@latest add toast
```

## 完了条件
- [ ] 買取申込フォームが表示されている
- [ ] バリデーションが動作している
- [ ] 画像アップロードが動作している
- [ ] データがSupabaseに保存されている
- [ ] 送信完了ページが表示されている
- [ ] エラーハンドリングが適切に実装されている

## 関連チケット
- 前: #008 アカウント詳細ページ
- 次: #010 管理画面認証とダッシュボード

## 参考
- [React Hook Form](https://react-hook-form.com/)
- [Zod Validation](https://zod.dev/)
- [Supabase Storage](https://supabase.com/docs/guides/storage)
