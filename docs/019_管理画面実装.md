# チケット #019: 管理画面実装

## 概要
管理者向けのダッシュボード、アカウント管理ページ、買取申込管理ページを実装します。
認証保護されたページで、アカウントの登録・編集・削除、買取申込の管理が可能になります。

## 目的
- 管理ダッシュボード（統計表示）
- アカウント管理画面（一覧・新規作成・編集・削除）
- 買取申込管理画面（一覧・ステータス更新）
- ログイン・ログアウト機能
- レスポンシブ対応

## タスク
- [x] 管理画面レイアウトの作成
  - [x] `app/admin/layout.tsx` - 管理画面共通レイアウト
  - [x] サイドバーナビゲーション
  - [x] ヘッダー（ユーザー情報・ログアウトボタン）
- [x] ログインページの実装
  - [x] `app/admin/login/page.tsx`
  - [x] ログインフォーム
  - [x] エラーハンドリング
- [x] ダッシュボードの実装
  - [x] `app/admin/page.tsx`
  - [x] 統計情報の表示
  - [x] 最近の申込一覧
- [x] アカウント管理ページの実装
  - [x] `app/admin/accounts/page.tsx` - 一覧
  - [x] `app/admin/accounts/new/page.tsx` - 新規作成
  - [x] `app/admin/accounts/[id]/edit/page.tsx` - 編集
  - [x] フィルター・検索機能
  - [x] ステータス変更機能
  - [x] 削除機能
- [x] 買取申込管理ページの実装
  - [x] `app/admin/requests/page.tsx` - 一覧
  - [x] ステータス変更機能
  - [x] 詳細表示モーダル
  - [x] フィルター機能
- [x] UI コンポーネントの実装
  - [x] データテーブル
  - [x] ページネーション
  - [x] フィルターUI
  - [x] ステータスバッジ
  - [x] 確認ダイアログ

## 技術実装

### 1. 管理画面レイアウト

#### `app/admin/layout.tsx`
```typescript
import { requireAuth } from '@/lib/auth-helpers'
import { redirect } from 'next/navigation'
import { AdminSidebar } from '@/components/admin/AdminSidebar'
import { AdminHeader } from '@/components/admin/AdminHeader'

export default async function AdminLayout({
  children,
}: {
  children: React.ReactNode
}) {
  let session
  try {
    session = await requireAuth()
  } catch (error) {
    redirect('/admin/login')
  }

  return (
    <div className="flex min-h-screen">
      <AdminSidebar />
      <div className="flex-1 flex flex-col">
        <AdminHeader session={session} />
        <main className="flex-1 p-6 bg-muted/10">{children}</main>
      </div>
    </div>
  )
}
```

#### `components/admin/AdminSidebar.tsx`
```typescript
'use client'

import Link from 'next/link'
import { usePathname } from 'next/navigation'
import { cn } from '@/lib/utils'
import {
  LayoutDashboard,
  Users,
  MessageSquare,
} from 'lucide-react'

const navigation = [
  { name: 'ダッシュボード', href: '/admin', icon: LayoutDashboard },
  { name: 'アカウント管理', href: '/admin/accounts', icon: Users },
  { name: '買取申込', href: '/admin/requests', icon: MessageSquare },
]

export function AdminSidebar() {
  const pathname = usePathname()

  return (
    <aside className="w-64 bg-card border-r">
      <div className="p-6">
        <h1 className="text-2xl font-bold text-primary">XSTORE Admin</h1>
      </div>
      <nav className="space-y-1 px-3">
        {navigation.map((item) => {
          const isActive = pathname === item.href || pathname.startsWith(item.href + '/')
          return (
            <Link
              key={item.name}
              href={item.href}
              className={cn(
                'flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition',
                isActive
                  ? 'bg-primary text-primary-foreground'
                  : 'text-muted-foreground hover:bg-muted'
              )}
            >
              <item.icon className="h-5 w-5" />
              {item.name}
            </Link>
          )
        })}
      </nav>
    </aside>
  )
}
```

#### `components/admin/AdminHeader.tsx`
```typescript
'use client'

import { signOut } from 'next-auth/react'
import { Button } from '@/components/ui/button'
import { LogOut } from 'lucide-react'

export function AdminHeader({ session }: { session: any }) {
  return (
    <header className="h-16 border-b bg-card px-6 flex items-center justify-between">
      <div />
      <div className="flex items-center gap-4">
        <span className="text-sm text-muted-foreground">
          {session.user?.email}
        </span>
        <Button
          variant="ghost"
          size="sm"
          onClick={() => signOut({ callbackUrl: '/admin/login' })}
        >
          <LogOut className="h-4 w-4 mr-2" />
          ログアウト
        </Button>
      </div>
    </header>
  )
}
```

### 2. ダッシュボード

#### `app/admin/page.tsx`
```typescript
import { createServerClient } from '@/lib/supabase'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Users, DollarSign, MessageSquare, TrendingUp } from 'lucide-react'

export default async function AdminDashboard() {
  const supabase = createServerClient()

  // 統計情報の取得
  const [
    { count: totalAccounts },
    { count: availableAccounts },
    { count: soldAccounts },
    { count: pendingRequests },
  ] = await Promise.all([
    supabase.from('accounts').select('*', { count: 'exact', head: true }),
    supabase.from('accounts').select('*', { count: 'exact', head: true }).eq('status', 'available'),
    supabase.from('accounts').select('*', { count: 'exact', head: true }).eq('status', 'sold'),
    supabase.from('purchase_requests').select('*', { count: 'exact', head: true }).eq('status', 'pending'),
  ])

  // 最近の買取申込
  const { data: recentRequests } = await supabase
    .from('purchase_requests')
    .select('*')
    .order('created_at', { ascending: false })
    .limit(5)

  return (
    <div className="space-y-6">
      <h1 className="text-3xl font-bold">ダッシュボード</h1>

      {/* 統計カード */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">総アカウント数</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{totalAccounts || 0}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">販売中</CardTitle>
            <TrendingUp className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{availableAccounts || 0}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">売却済み</CardTitle>
            <DollarSign className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{soldAccounts || 0}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">未対応の申込</CardTitle>
            <MessageSquare className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{pendingRequests || 0}</div>
          </CardContent>
        </Card>
      </div>

      {/* 最近の買取申込 */}
      <Card>
        <CardHeader>
          <CardTitle>最近の買取申込</CardTitle>
        </CardHeader>
        <CardContent>
          {recentRequests && recentRequests.length > 0 ? (
            <div className="space-y-4">
              {recentRequests.map((request) => (
                <div key={request.id} className="flex items-center justify-between border-b pb-2">
                  <div>
                    <p className="font-medium">@{request.twitter_username}</p>
                    <p className="text-sm text-muted-foreground">
                      希望価格: ¥{request.desired_price.toLocaleString()}
                    </p>
                  </div>
                  <div className="text-xs text-muted-foreground">
                    {new Date(request.created_at).toLocaleDateString('ja-JP')}
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <p className="text-sm text-muted-foreground">まだ申込がありません</p>
          )}
        </CardContent>
      </Card>
    </div>
  )
}
```

### 3. アカウント管理 - 一覧

#### `app/admin/accounts/page.tsx`
```typescript
import { createServerClient } from '@/lib/supabase'
import { AccountsTable } from '@/components/admin/AccountsTable'
import { Button } from '@/components/ui/button'
import Link from 'next/link'
import { Plus } from 'lucide-react'

export default async function AccountsPage({
  searchParams,
}: {
  searchParams: { page?: string; status?: string }
}) {
  const supabase = createServerClient()
  const page = parseInt(searchParams.page || '1')
  const status = searchParams.status
  const limit = 20

  // アカウント一覧の取得
  let query = supabase
    .from('accounts')
    .select('*', { count: 'exact' })
    .order('created_at', { ascending: false })
    .range((page - 1) * limit, page * limit - 1)

  if (status) {
    query = query.eq('status', status)
  }

  const { data: accounts, count } = await query

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold">アカウント管理</h1>
        <Button asChild>
          <Link href="/admin/accounts/new">
            <Plus className="h-4 w-4 mr-2" />
            新規登録
          </Link>
        </Button>
      </div>

      <AccountsTable
        accounts={accounts || []}
        total={count || 0}
        page={page}
        limit={limit}
      />
    </div>
  )
}
```

#### `components/admin/AccountsTable.tsx`
```typescript
'use client'

import { Account } from '@/types'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import Link from 'next/link'
import { Edit, Trash2 } from 'lucide-react'
import { useRouter } from 'next/navigation'

interface AccountsTableProps {
  accounts: Account[]
  total: number
  page: number
  limit: number
}

export function AccountsTable({ accounts, total, page, limit }: AccountsTableProps) {
  const router = useRouter()

  const handleDelete = async (id: string) => {
    if (!confirm('本当に削除しますか？')) return

    try {
      const response = await fetch(`/api/accounts/${id}`, {
        method: 'DELETE',
      })

      if (response.ok) {
        router.refresh()
      }
    } catch (error) {
      console.error('Delete error:', error)
    }
  }

  const statusColors = {
    available: 'bg-green-500',
    sold: 'bg-gray-500',
    pending: 'bg-yellow-500',
  }

  const statusLabels = {
    available: '販売中',
    sold: '売却済み',
    pending: '保留中',
  }

  return (
    <div className="space-y-4">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>ユーザー名</TableHead>
            <TableHead>フォロワー</TableHead>
            <TableHead>ツイート数</TableHead>
            <TableHead>価格</TableHead>
            <TableHead>カテゴリ</TableHead>
            <TableHead>ステータス</TableHead>
            <TableHead>作成日</TableHead>
            <TableHead className="text-right">操作</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {accounts.map((account) => (
            <TableRow key={account.id}>
              <TableCell className="font-medium">@{account.username}</TableCell>
              <TableCell>{account.followers_count.toLocaleString()}</TableCell>
              <TableCell>{account.tweets_count.toLocaleString()}</TableCell>
              <TableCell>¥{account.price.toLocaleString()}</TableCell>
              <TableCell>{account.category}</TableCell>
              <TableCell>
                <Badge className={statusColors[account.status]}>
                  {statusLabels[account.status]}
                </Badge>
              </TableCell>
              <TableCell>
                {new Date(account.created_at).toLocaleDateString('ja-JP')}
              </TableCell>
              <TableCell className="text-right space-x-2">
                <Button variant="ghost" size="sm" asChild>
                  <Link href={`/admin/accounts/${account.id}/edit`}>
                    <Edit className="h-4 w-4" />
                  </Link>
                </Button>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => handleDelete(account.id)}
                >
                  <Trash2 className="h-4 w-4 text-red-500" />
                </Button>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>

      {/* ページネーション */}
      <div className="flex items-center justify-between">
        <p className="text-sm text-muted-foreground">
          全{total}件中 {(page - 1) * limit + 1}-{Math.min(page * limit, total)}件を表示
        </p>
        <div className="flex gap-2">
          <Button
            variant="outline"
            size="sm"
            disabled={page === 1}
            onClick={() => router.push(`/admin/accounts?page=${page - 1}`)}
          >
            前へ
          </Button>
          <Button
            variant="outline"
            size="sm"
            disabled={page * limit >= total}
            onClick={() => router.push(`/admin/accounts?page=${page + 1}`)}
          >
            次へ
          </Button>
        </div>
      </div>
    </div>
  )
}
```

### 4. アカウント管理 - 新規作成

#### `app/admin/accounts/new/page.tsx`
```typescript
import { AccountForm } from '@/components/admin/AccountForm'

export default function NewAccountPage() {
  return (
    <div className="max-w-2xl">
      <h1 className="text-3xl font-bold mb-6">新規アカウント登録</h1>
      <AccountForm />
    </div>
  )
}
```

#### `components/admin/AccountForm.tsx`
```typescript
'use client'

import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { createAccountSchema, CreateAccountInput } from '@/lib/validations'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Textarea } from '@/components/ui/textarea'
import { ImageUpload } from '@/components/forms/ImageUpload'
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { useRouter } from 'next/navigation'
import { useState } from 'react'
import { Account } from '@/types'

interface AccountFormProps {
  account?: Account
}

export function AccountForm({ account }: AccountFormProps) {
  const router = useRouter()
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')

  const form = useForm<CreateAccountInput>({
    resolver: zodResolver(createAccountSchema),
    defaultValues: account
      ? {
          username: account.username,
          display_name: account.display_name || '',
          followers_count: account.followers_count,
          following_count: account.following_count,
          tweets_count: account.tweets_count,
          account_created_date: account.account_created_date || undefined,
          price: account.price,
          category: account.category || undefined,
          description: account.description || '',
          image_url: account.image_url || undefined,
        }
      : {
          username: '',
          followers_count: 0,
          following_count: 0,
          tweets_count: 0,
          price: 0,
        },
  })

  const onSubmit = async (data: CreateAccountInput) => {
    setLoading(true)
    setError('')

    try {
      const url = account ? `/api/accounts/${account.id}` : '/api/accounts'
      const method = account ? 'PUT' : 'POST'

      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      })

      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.error || '保存に失敗しました')
      }

      router.push('/admin/accounts')
      router.refresh()
    } catch (error) {
      setError(error instanceof Error ? error.message : '保存に失敗しました')
    } finally {
      setLoading(false)
    }
  }

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
        <FormField
          control={form.control}
          name="image_url"
          render={({ field }) => (
            <FormItem>
              <FormLabel>プロフィール画像</FormLabel>
              <FormControl>
                <ImageUpload
                  value={field.value}
                  onChange={field.onChange}
                  endpoint="/api/upload/account-image"
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <FormField
          control={form.control}
          name="username"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Twitter ID *</FormLabel>
              <FormControl>
                <Input placeholder="@username" {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <FormField
          control={form.control}
          name="display_name"
          render={({ field }) => (
            <FormItem>
              <FormLabel>表示名</FormLabel>
              <FormControl>
                <Input placeholder="表示名" {...field} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <div className="grid grid-cols-3 gap-4">
          <FormField
            control={form.control}
            name="followers_count"
            render={({ field }) => (
              <FormItem>
                <FormLabel>フォロワー数 *</FormLabel>
                <FormControl>
                  <Input
                    type="number"
                    {...field}
                    onChange={(e) => field.onChange(parseInt(e.target.value))}
                  />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="following_count"
            render={({ field }) => (
              <FormItem>
                <FormLabel>フォロー数</FormLabel>
                <FormControl>
                  <Input
                    type="number"
                    {...field}
                    onChange={(e) => field.onChange(parseInt(e.target.value))}
                  />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />

          <FormField
            control={form.control}
            name="tweets_count"
            render={({ field }) => (
              <FormItem>
                <FormLabel>ツイート数 *</FormLabel>
                <FormControl>
                  <Input
                    type="number"
                    {...field}
                    onChange={(e) => field.onChange(parseInt(e.target.value))}
                  />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
        </div>

        <FormField
          control={form.control}
          name="price"
          render={({ field }) => (
            <FormItem>
              <FormLabel>価格（円） *</FormLabel>
              <FormControl>
                <Input
                  type="number"
                  {...field}
                  onChange={(e) => field.onChange(parseInt(e.target.value))}
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <FormField
          control={form.control}
          name="category"
          render={({ field }) => (
            <FormItem>
              <FormLabel>カテゴリ</FormLabel>
              <Select onValueChange={field.onChange} defaultValue={field.value}>
                <FormControl>
                  <SelectTrigger>
                    <SelectValue placeholder="カテゴリを選択" />
                  </SelectTrigger>
                </FormControl>
                <SelectContent>
                  <SelectItem value="ビジネス">ビジネス</SelectItem>
                  <SelectItem value="エンタメ">エンタメ</SelectItem>
                  <SelectItem value="スポーツ">スポーツ</SelectItem>
                  <SelectItem value="ニュース">ニュース</SelectItem>
                  <SelectItem value="その他">その他</SelectItem>
                </SelectContent>
              </Select>
              <FormMessage />
            </FormItem>
          )}
        />

        <FormField
          control={form.control}
          name="description"
          render={({ field }) => (
            <FormItem>
              <FormLabel>説明</FormLabel>
              <FormControl>
                <Textarea placeholder="アカウントの説明..." {...field} rows={5} />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        {error && <p className="text-sm text-red-500">{error}</p>}

        <div className="flex gap-4">
          <Button type="submit" disabled={loading}>
            {loading ? '保存中...' : account ? '更新' : '登録'}
          </Button>
          <Button
            type="button"
            variant="outline"
            onClick={() => router.back()}
          >
            キャンセル
          </Button>
        </div>
      </form>
    </Form>
  )
}
```

### 5. 買取申込管理

#### `app/admin/requests/page.tsx`
```typescript
import { createServerClient } from '@/lib/supabase'
import { RequestsTable } from '@/components/admin/RequestsTable'

export default async function RequestsPage({
  searchParams,
}: {
  searchParams: { page?: string; status?: string }
}) {
  const supabase = createServerClient()
  const page = parseInt(searchParams.page || '1')
  const status = searchParams.status
  const limit = 20

  // 買取申込一覧の取得
  let query = supabase
    .from('purchase_requests')
    .select('*', { count: 'exact' })
    .order('created_at', { ascending: false })
    .range((page - 1) * limit, page * limit - 1)

  if (status) {
    query = query.eq('status', status)
  }

  const { data: requests, count } = await query

  return (
    <div className="space-y-6">
      <h1 className="text-3xl font-bold">買取申込管理</h1>
      <RequestsTable
        requests={requests || []}
        total={count || 0}
        page={page}
        limit={limit}
      />
    </div>
  )
}
```

## 関連ファイル
- `lib/auth.ts` - NextAuth 設定
- `lib/auth-helpers.ts` - 認証ヘルパー
- `lib/validations.ts` - バリデーションスキーマ
- `components/ui/*` - UI コンポーネント
- API Routes（チケット #014, #015）

## 依存関係
- チケット #014: アカウント管理 API（完了必須）
- チケット #015: 買取申込管理 API（完了必須）
- チケット #016: 認証システム（完了必須）
- チケット #017: 画像アップロード機能（完了必須）
- チケット #018: バリデーション（完了必須）

## 完了条件
- [x] 管理画面レイアウトが実装されている
- [x] ログイン・ログアウトが正常に動作する
- [x] ダッシュボードが表示される
- [x] アカウント管理機能（一覧・作成・編集・削除）が動作する
- [x] 買取申込管理機能（一覧・ステータス更新）が動作する
- [x] フィルター・検索機能が動作する
- [x] ページネーションが動作する
- [x] レスポンシブ対応されている
- [x] エラーハンドリングが適切に実装されている

## 備考
- データテーブルには Shadcn/ui の Table コンポーネントを使用
- ページネーションはサーバーサイドで実装
- 削除時は確認ダイアログを表示
- 統計情報はリアルタイムで取得
- 将来的にダッシュボードにグラフを追加予定
