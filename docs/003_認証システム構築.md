# チケット #003: 認証システム構築

## 概要
NextAuth.jsを使用した管理画面用の認証システムを構築します。

## 目的
- NextAuth.jsの設定
- 管理者ログイン機能の実装
- 認証保護ミドルウェアの実装
- セッション管理

## タスク

### NextAuth.js 設定
- [ ] `/lib/auth.ts` 作成（NextAuth設定）
  - Credentials Provider設定
  - JWT設定
  - セッション設定
- [ ] `/app/api/auth/[...nextauth]/route.ts` 作成（NextAuth API Route）

### 認証ロジック実装
- [ ] bcryptjsを使用したパスワード検証関数作成
- [ ] Supabaseから管理者情報を取得する関数作成
- [ ] ログイン処理実装

### ミドルウェア設定
- [ ] `/middleware.ts` 作成
  - `/admin/*` パスの認証保護
  - 未認証時は `/admin/login` にリダイレクト

### 型定義
- [ ] NextAuth用の型定義拡張
  - `next-auth.d.ts` 作成
  - User, Session型の拡張

### 環境変数
- [ ] `NEXTAUTH_SECRET` の設定
- [ ] `NEXTAUTH_URL` の設定

## 技術的な詳細

### NextAuth設定（lib/auth.ts）
```typescript
import { NextAuthOptions } from 'next-auth';
import CredentialsProvider from 'next-auth/providers/credentials';
import bcrypt from 'bcryptjs';
import { createClient } from '@/lib/supabase';

export const authOptions: NextAuthOptions = {
  providers: [
    CredentialsProvider({
      name: 'credentials',
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' }
      },
      async authorize(credentials) {
        if (!credentials?.email || !credentials?.password) {
          return null;
        }

        const supabase = createClient();
        const { data: admin, error } = await supabase
          .from('admins')
          .select('*')
          .eq('email', credentials.email)
          .single();

        if (error || !admin) {
          return null;
        }

        const isPasswordValid = await bcrypt.compare(
          credentials.password,
          admin.password_hash
        );

        if (!isPasswordValid) {
          return null;
        }

        return {
          id: admin.id,
          email: admin.email,
          name: admin.name,
        };
      },
    }),
  ],
  session: {
    strategy: 'jwt',
  },
  pages: {
    signIn: '/admin/login',
  },
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.id = user.id;
      }
      return token;
    },
    async session({ session, token }) {
      if (session.user) {
        session.user.id = token.id as string;
      }
      return session;
    },
  },
};
```

### API Route（app/api/auth/[...nextauth]/route.ts）
```typescript
import NextAuth from 'next-auth';
import { authOptions } from '@/lib/auth';

const handler = NextAuth(authOptions);

export { handler as GET, handler as POST };
```

### ミドルウェア（middleware.ts）
```typescript
export { default } from 'next-auth/middleware';

export const config = {
  matcher: ['/admin/:path*'],
};
```

または、カスタムミドルウェア:
```typescript
import { withAuth } from 'next-auth/middleware';

export default withAuth({
  callbacks: {
    authorized: ({ token }) => !!token,
  },
});

export const config = {
  matcher: ['/admin/:path*'],
};
```

### 型定義拡張（next-auth.d.ts）
```typescript
import 'next-auth';

declare module 'next-auth' {
  interface User {
    id: string;
  }

  interface Session {
    user: {
      id: string;
      email: string;
      name: string;
    };
  }
}

declare module 'next-auth/jwt' {
  interface JWT {
    id: string;
  }
}
```

### パスワードハッシュ生成（初期管理者作成用）
```typescript
import bcrypt from 'bcryptjs';

const password = 'your_password';
const hashedPassword = await bcrypt.hash(password, 10);
console.log(hashedPassword);
```

## 完了条件
- [ ] NextAuth.jsが正常に動作している
- [ ] ログイン機能が実装されている
- [ ] `/admin/*` パスが認証保護されている
- [ ] セッションが正常に管理されている
- [ ] 型定義が正しく設定されている

## 関連チケット
- 前: #002 データベース設計とSupabaseセットアップ
- 次: #004 カラースキームとテーマ設定

## 参考
- [NextAuth.js Documentation](https://next-auth.js.org/)
- [NextAuth.js with Credentials](https://next-auth.js.org/providers/credentials)
