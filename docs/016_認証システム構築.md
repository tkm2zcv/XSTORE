# チケット #016: 認証ミドルウェアとセッション管理

## 概要
NextAuth.js を使用した管理者認証システムを構築します。
Supabase の admins テーブルを使用し、メールアドレス + パスワードでの認証を実装します。

## 目的
- NextAuth.js のセットアップ
- 管理者認証機能の実装
- セッション管理の実装
- API Routes での認証チェック機能
- ミドルウェアによる管理画面の保護

## タスク
- [x] NextAuth.js のインストールと設定
  - [x] `npm install next-auth`
  - [x] `npm install bcryptjs @types/bcryptjs`
- [x] NextAuth.js の設定ファイル作成
  - [x] `app/api/auth/[...nextauth]/route.ts` を作成
  - [x] `lib/auth.ts` に認証設定を記述
- [x] 認証プロバイダーの実装
  - [x] Credentials Provider（メール + パスワード）
  - [x] bcrypt によるパスワード検証
- [x] セッション管理の実装
  - [x] JWT ベースのセッション
  - [x] セッションの型定義
- [x] 認証ヘルパー関数の実装
  - [x] `getServerSession()` のラッパー
  - [x] API Routes 用認証チェック関数
- [x] ミドルウェアの実装
  - [x] `middleware.ts` を作成
  - [x] `/admin` 配下のページ保護
- [x] 環境変数の設定
  - [x] `NEXTAUTH_SECRET` の追加
  - [x] `NEXTAUTH_URL` の追加
- [x] 型定義の拡張
  - [x] NextAuth の型を拡張（User, Session）

## 技術実装

### 1. NextAuth.js 設定

#### `lib/auth.ts`
```typescript
import { NextAuthOptions } from 'next-auth'
import CredentialsProvider from 'next-auth/providers/credentials'
import bcrypt from 'bcryptjs'
import { createAdminClient } from '@/lib/supabase'

export const authOptions: NextAuthOptions = {
  providers: [
    CredentialsProvider({
      name: 'Credentials',
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' },
      },
      async authorize(credentials) {
        if (!credentials?.email || !credentials?.password) {
          return null
        }

        try {
          const supabase = createAdminClient()
          const { data: admin, error } = await supabase
            .from('admins')
            .select('*')
            .eq('email', credentials.email)
            .single()

          if (error || !admin) {
            return null
          }

          // パスワード検証
          const isValid = await bcrypt.compare(
            credentials.password,
            admin.password_hash
          )

          if (!isValid) {
            return null
          }

          // last_login_at を更新
          await supabase
            .from('admins')
            .update({ last_login_at: new Date().toISOString() })
            .eq('id', admin.id)

          return {
            id: admin.id,
            email: admin.email,
            name: admin.name,
          }
        } catch (error) {
          console.error('Auth error:', error)
          return null
        }
      },
    }),
  ],
  session: {
    strategy: 'jwt',
    maxAge: 30 * 24 * 60 * 60, // 30日
  },
  pages: {
    signIn: '/admin/login',
    error: '/admin/login',
  },
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.id = user.id
        token.email = user.email
        token.name = user.name
      }
      return token
    },
    async session({ session, token }) {
      if (token && session.user) {
        session.user.id = token.id as string
        session.user.email = token.email as string
        session.user.name = token.name as string
      }
      return session
    },
  },
  secret: process.env.NEXTAUTH_SECRET,
}
```

#### `app/api/auth/[...nextauth]/route.ts`
```typescript
import NextAuth from 'next-auth'
import { authOptions } from '@/lib/auth'

const handler = NextAuth(authOptions)

export { handler as GET, handler as POST }
```

### 2. 認証ヘルパー関数

#### `lib/auth-helpers.ts`
```typescript
import { getServerSession } from 'next-auth'
import { authOptions } from '@/lib/auth'
import { NextRequest, NextResponse } from 'next/server'

/**
 * Server Component でセッションを取得
 */
export async function getSession() {
  return await getServerSession(authOptions)
}

/**
 * Server Component で認証チェック
 */
export async function requireAuth() {
  const session = await getSession()
  if (!session) {
    throw new Error('Unauthorized')
  }
  return session
}

/**
 * API Route で認証チェック
 */
export async function checkAuth(request: NextRequest) {
  const session = await getServerSession(authOptions)
  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }
  return { session }
}
```

### 3. ミドルウェア

#### `middleware.ts`
```typescript
import { withAuth } from 'next-auth/middleware'

export default withAuth({
  callbacks: {
    authorized: ({ token }) => !!token,
  },
  pages: {
    signIn: '/admin/login',
  },
})

export const config = {
  matcher: ['/admin/:path*', '/api/admin/:path*'],
}
```

### 4. 型定義の拡張

#### `types/next-auth.d.ts`
```typescript
import { DefaultSession, DefaultUser } from 'next-auth'

declare module 'next-auth' {
  interface Session {
    user: {
      id: string
      email: string
      name: string | null
    } & DefaultSession['user']
  }

  interface User extends DefaultUser {
    id: string
    email: string
    name: string | null
  }
}

declare module 'next-auth/jwt' {
  interface JWT {
    id: string
    email: string
    name: string | null
  }
}
```

### 5. SessionProvider のセットアップ

#### `app/providers.tsx`
```typescript
'use client'

import { SessionProvider } from 'next-auth/react'

export function Providers({ children }: { children: React.ReactNode }) {
  return <SessionProvider>{children}</SessionProvider>
}
```

#### `app/layout.tsx` に追加
```typescript
import { Providers } from './providers'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>
        <Providers>{children}</Providers>
      </body>
    </html>
  )
}
```

### 6. 管理者ログインページ

#### `app/admin/login/page.tsx`
```typescript
'use client'

import { signIn } from 'next-auth/react'
import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'

export default function LoginPage() {
  const router = useRouter()
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState('')
  const [loading, setLoading] = useState(false)

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setError('')
    setLoading(true)

    try {
      const result = await signIn('credentials', {
        email,
        password,
        redirect: false,
      })

      if (result?.error) {
        setError('メールアドレスまたはパスワードが正しくありません')
      } else {
        router.push('/admin')
        router.refresh()
      }
    } catch (error) {
      setError('ログインに失敗しました')
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="container flex items-center justify-center min-h-screen">
      <Card className="w-full max-w-md">
        <CardHeader>
          <CardTitle>管理者ログイン</CardTitle>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div>
              <Input
                type="email"
                placeholder="メールアドレス"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
              />
            </div>
            <div>
              <Input
                type="password"
                placeholder="パスワード"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
              />
            </div>
            {error && <p className="text-sm text-red-500">{error}</p>}
            <Button type="submit" className="w-full" disabled={loading}>
              {loading ? 'ログイン中...' : 'ログイン'}
            </Button>
          </form>
        </CardContent>
      </Card>
    </div>
  )
}
```

### 7. API Routes での使用例

#### `app/api/accounts/route.ts` の POST を更新
```typescript
import { checkAuth } from '@/lib/auth-helpers'

export async function POST(request: NextRequest) {
  // 認証チェック
  const authResult = await checkAuth(request)
  if (authResult instanceof NextResponse) {
    return authResult // 401 エラー
  }

  const { session } = authResult

  // 以降の処理...
}
```

### 8. 管理画面での使用例

#### `app/admin/page.tsx`
```typescript
import { requireAuth } from '@/lib/auth-helpers'
import { redirect } from 'next/navigation'

export default async function AdminDashboard() {
  try {
    const session = await requireAuth()
  } catch (error) {
    redirect('/admin/login')
  }

  return (
    <div>
      <h1>管理ダッシュボード</h1>
    </div>
  )
}
```

## 環境変数

### `.env.local` に追加
```env
# ============================================
# NextAuth Configuration
# ============================================
# ランダムな文字列を生成: openssl rand -base64 32
NEXTAUTH_SECRET=your_nextauth_secret_here

# 開発環境
NEXTAUTH_URL=http://localhost:3000

# 本番環境（デプロイ時に変更）
# NEXTAUTH_URL=https://your-domain.com
```

## 初期管理者アカウントの作成

### SQL で初期管理者を作成
```sql
-- パスワードは bcrypt でハッシュ化する必要があります
-- 例: "admin123" のハッシュ
-- Node.js で生成: bcrypt.hashSync('admin123', 10)

INSERT INTO admins (email, password_hash, name)
VALUES (
  'admin@example.com',
  '$2a$10$YourBcryptHashHere',
  'Admin User'
);
```

### または、初回セットアップスクリプトを作成
```typescript
// scripts/create-admin.ts
import bcrypt from 'bcryptjs'
import { createAdminClient } from '@/lib/supabase'

async function createAdmin() {
  const email = 'admin@example.com'
  const password = 'admin123' // 初回ログイン後に変更
  const name = 'Admin User'

  const passwordHash = await bcrypt.hash(password, 10)

  const supabase = createAdminClient()
  const { data, error } = await supabase
    .from('admins')
    .insert({
      email,
      password_hash: passwordHash,
      name,
    })
    .select()
    .single()

  if (error) {
    console.error('Error:', error)
  } else {
    console.log('Admin created:', data)
  }
}

createAdmin()
```

## セキュリティ考慮事項

### パスワードポリシー
- 最小8文字
- 英数字＋記号の組み合わせを推奨
- 定期的な変更を推奨

### セッション管理
- JWT ベース（サーバーレスに対応）
- 有効期限: 30日
- HTTPS 必須（本番環境）

### CSRF 対策
- NextAuth.js が自動的に CSRF トークンを管理

### XSS 対策
- React の自動エスケープ
- Content Security Policy の設定を推奨

## 関連ファイル
- `lib/supabase.ts` - Supabase クライアント
- `supabase/schema.sql` - admins テーブル定義
- `types/index.ts` - Admin 型定義

## 依存関係
- チケット #002: データベース設計（完了）
- チケット #014: アカウント管理 API（認証チェックで使用）
- チケット #015: 買取申込管理 API（認証チェックで使用）

## 完了条件
- [x] NextAuth.js が正常に動作する
- [x] 管理者ログインが正常に動作する
- [x] セッション管理が正常に動作する
- [x] ミドルウェアによるページ保護が機能する
- [x] API Routes での認証チェックが機能する
- [x] ログアウトが正常に動作する

## 備考
- 初期管理者アカウントは手動で作成する必要があります
- 本番環境では `NEXTAUTH_URL` を適切に設定してください
- パスワードリセット機能は将来の拡張として別チケットで実装
