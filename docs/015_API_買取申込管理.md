# チケット #015: API Routes - 買取申込管理API

## 概要
買取申込の作成・管理を行う API Routes を実装します。
公開フォームからの申込作成、管理画面での申込一覧・ステータス更新機能を提供します。

## 目的
- 買取申込の作成（公開、認証不要）
- 買取申込一覧の取得（管理者のみ）
- 買取申込の詳細取得（管理者のみ）
- 買取申込のステータス更新（管理者のみ）
- 買取申込の削除（管理者のみ）

## タスク
- [x] `app/api/purchase-requests/route.ts` を作成
  - [x] GET: 申込一覧取得（認証チェック）
  - [x] POST: 申込作成（公開、認証不要）
- [x] `app/api/purchase-requests/[id]/route.ts` を作成
  - [x] GET: 特定申込の詳細取得（認証チェック）
  - [x] PATCH: ステータス更新（認証チェック）
  - [x] DELETE: 申込削除（認証チェック）
- [x] クエリパラメータ処理の実装
  - [x] フィルター: `status`, `startDate`, `endDate`
  - [x] ソート: `created_at`, `desired_price`
  - [x] ページネーション: `page`, `limit`
- [x] エラーハンドリングの実装
  - [x] 404: 申込が見つからない
  - [x] 401: 認証エラー
  - [x] 400: バリデーションエラー
  - [x] 500: サーバーエラー
- [x] レスポンス形式の統一
  - [x] 成功時: `{ data: T }`
  - [x] エラー時: `{ error: string }`

## 技術実装

### エンドポイント仕様

#### GET `/api/purchase-requests`
```typescript
// クエリパラメータ（管理者のみ）
interface PurchaseRequestsQuery {
  status?: 'pending' | 'reviewing' | 'approved' | 'rejected'
  startDate?: string // ISO 8601 format
  endDate?: string
  sortBy?: 'created_at' | 'desired_price'
  order?: 'asc' | 'desc'
  page?: number
  limit?: number
}

// レスポンス
interface PurchaseRequestsResponse {
  data: PurchaseRequest[]
  pagination: {
    page: number
    limit: number
    total: number
    totalPages: number
  }
}
```

#### GET `/api/purchase-requests/[id]`
```typescript
// レスポンス（管理者のみ）
interface PurchaseRequestResponse {
  data: PurchaseRequest
}
```

#### POST `/api/purchase-requests`
```typescript
// リクエストボディ（公開、認証不要）
interface CreatePurchaseRequestBody {
  twitter_username: string
  desired_price: number
  contact_email?: string
  contact_twitter?: string
  contact_instagram?: string
  message?: string
  has_image_tweet: boolean
}

// レスポンス
interface CreatePurchaseRequestResponse {
  data: PurchaseRequest
}
```

#### PATCH `/api/purchase-requests/[id]`
```typescript
// リクエストボディ（管理者のみ）
interface UpdatePurchaseRequestBody {
  status: 'pending' | 'reviewing' | 'approved' | 'rejected'
}

// レスポンス
interface UpdatePurchaseRequestResponse {
  data: PurchaseRequest
}
```

#### DELETE `/api/purchase-requests/[id]`
```typescript
// レスポンス（管理者のみ）
interface DeletePurchaseRequestResponse {
  data: { id: string }
}
```

## 実装例

### `app/api/purchase-requests/route.ts`
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createServerClient } from '@/lib/supabase'

export async function GET(request: NextRequest) {
  try {
    // TODO: 認証チェック（チケット #016 で実装）
    // const session = await getServerSession()
    // if (!session) {
    //   return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    // }

    const supabase = createServerClient()
    const { searchParams } = new URL(request.url)

    // クエリパラメータの取得
    const status = searchParams.get('status')
    const startDate = searchParams.get('startDate')
    const endDate = searchParams.get('endDate')
    const sortBy = searchParams.get('sortBy') || 'created_at'
    const order = searchParams.get('order') || 'desc'
    const page = parseInt(searchParams.get('page') || '1')
    const limit = parseInt(searchParams.get('limit') || '20')

    // クエリ構築
    let query = supabase
      .from('purchase_requests')
      .select('*', { count: 'exact' })

    // フィルター適用
    if (status) query = query.eq('status', status)
    if (startDate) query = query.gte('created_at', startDate)
    if (endDate) query = query.lte('created_at', endDate)

    // ソート適用
    query = query.order(sortBy, { ascending: order === 'asc' })

    // ページネーション適用
    const from = (page - 1) * limit
    const to = from + limit - 1
    query = query.range(from, to)

    const { data, error, count } = await query

    if (error) {
      return NextResponse.json({ error: error.message }, { status: 500 })
    }

    return NextResponse.json({
      data,
      pagination: {
        page,
        limit,
        total: count || 0,
        totalPages: Math.ceil((count || 0) / limit),
      },
    })
  } catch (error) {
    return NextResponse.json(
      { error: 'Internal Server Error' },
      { status: 500 }
    )
  }
}

export async function POST(request: NextRequest) {
  try {
    const supabase = createServerClient()
    const body = await request.json()

    // TODO: バリデーション（チケット #018 で実装）
    // - twitter_username: 必須、Twitter ID形式
    // - desired_price: 必須、正の整数
    // - 少なくとも1つの連絡先が必要
    // - has_image_tweet: 必須、boolean

    const { data, error } = await supabase
      .from('purchase_requests')
      .insert({
        twitter_username: body.twitter_username,
        desired_price: body.desired_price,
        contact_email: body.contact_email || null,
        contact_twitter: body.contact_twitter || null,
        contact_instagram: body.contact_instagram || null,
        message: body.message || null,
        has_image_tweet: body.has_image_tweet,
        status: 'pending',
      })
      .select()
      .single()

    if (error) {
      return NextResponse.json({ error: error.message }, { status: 400 })
    }

    return NextResponse.json({ data }, { status: 201 })
  } catch (error) {
    return NextResponse.json(
      { error: 'Internal Server Error' },
      { status: 500 }
    )
  }
}
```

### `app/api/purchase-requests/[id]/route.ts`
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createServerClient } from '@/lib/supabase'

export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    // TODO: 認証チェック（チケット #016 で実装）

    const supabase = createServerClient()
    const { data, error } = await supabase
      .from('purchase_requests')
      .select('*')
      .eq('id', params.id)
      .single()

    if (error) {
      return NextResponse.json(
        { error: 'Purchase request not found' },
        { status: 404 }
      )
    }

    return NextResponse.json({ data })
  } catch (error) {
    return NextResponse.json(
      { error: 'Internal Server Error' },
      { status: 500 }
    )
  }
}

export async function PATCH(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    // TODO: 認証チェック（チケット #016 で実装）

    const supabase = createServerClient()
    const body = await request.json()

    // TODO: バリデーション（チケット #018 で実装）
    // - status: 必須、'pending' | 'reviewing' | 'approved' | 'rejected'

    const { data, error } = await supabase
      .from('purchase_requests')
      .update({ status: body.status })
      .eq('id', params.id)
      .select()
      .single()

    if (error) {
      return NextResponse.json({ error: error.message }, { status: 400 })
    }

    return NextResponse.json({ data })
  } catch (error) {
    return NextResponse.json(
      { error: 'Internal Server Error' },
      { status: 500 }
    )
  }
}

export async function DELETE(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    // TODO: 認証チェック（チケット #016 で実装）

    const supabase = createServerClient()
    const { error } = await supabase
      .from('purchase_requests')
      .delete()
      .eq('id', params.id)

    if (error) {
      return NextResponse.json({ error: error.message }, { status: 400 })
    }

    return NextResponse.json({ data: { id: params.id } })
  } catch (error) {
    return NextResponse.json(
      { error: 'Internal Server Error' },
      { status: 500 }
    )
  }
}
```

## セキュリティ考慮事項

### RLS ポリシー
- `purchase_requests` テーブルの RLS ポリシー:
  - `INSERT`: 誰でも作成可能（公開フォーム用）
  - `SELECT/UPDATE/DELETE`: 認証済みユーザー（管理者）のみ

### レート制限
- POST エンドポイントにはレート制限の実装を推奨
- IP アドレスごとに 1時間あたり 10 件まで（スパム防止）
- ※ レート制限は将来の拡張として別チケットで実装

## 関連ファイル
- `lib/supabase.ts` - Supabase クライアント
- `types/index.ts` - PurchaseRequest 型定義
- `supabase/schema.sql` - purchase_requests テーブル定義

## 依存関係
- チケット #002: データベース設計（完了）
- チケット #016: 認証ミドルウェア（GET/PATCH/DELETE で必要）
- チケット #018: バリデーション（全エンドポイントで必要）

## 完了条件
- [x] 全エンドポイントが正常に動作する
- [x] 公開フォームから申込作成が可能
- [x] 管理画面で申込一覧・詳細が取得可能
- [x] ステータス更新が正常に動作する
- [x] フィルター・ソート機能が正しく動作する
- [x] エラーハンドリングが適切に実装されている

## 備考
- POST エンドポイントは認証不要（公開フォーム用）
- GET/PATCH/DELETE は管理者のみアクセス可能
- 少なくとも1つの連絡先（email/twitter/instagram）が必要（DB制約）
- 画像アップロードは別チケット (#017) で実装
